#include <cmath>
#include <vector>

#include "TFile.h"
#include "TH2.h"
#include "TTree.h"

#include "../lib/ErrorHandler.h"
#include "../lib/ProgressBar.h"
#include "../lib/Particles.h"

struct
{
	std::vector<std::string> part_name;
	std::vector<float> m1, m2, weight;
} Par;

void AddEntry(std::string, float, float, float, bool = true);

void Init(TH2F *, TFile *);
	
void RestoreMass(const string, const float, const float, TH2F *, TFile *, const float = 1);

float GetMass(const float, const float, const float, const float, const float);

int RestoreRes()
{
	const float m1 = Mass.proton;
	const float m2 = Mass.kaon;

	std::string channel = "pk";

	string output_file_name = "../output/" + channel + ".root";

	CheckOutputFile(output_file_name);

	TH2F *mass_distr = new TH2F("mass_distr", "mass_distr", 100, 0, 10, 6000, 0, 12);

	//unindentified detector anomalies --------//
	//-----------------------------------------//

	//long living particles -------------------//
	
	//Any channel can be observed in the detector for that reason
	//even if it is not the channel the decay was
	if (channel == "pipi" || channel == "nopid")
	{
		//strange mesons
		AddEntry("KS", m1, m2, 0.692, 0);
	}
	else
	{
		AddEntry("KS", m1, m2, 0.692/10., 0);
	}
	
	if (channel == "kpi" || channel == "nopid")
	{
		//charmed mesons
		AddEntry("D0", m1, m2, 0.003947);
		//bottom mesons
		AddEntry("B0_kpi", m1, m2, 0.05);
		//lambda baryons
		AddEntry("Lambda", m1, m2, 0.639);
	}
	else
	{
		AddEntry("D0", m1, m2, 0.003947/10.);
		AddEntry("B0_kpi", m1, m2, 0.05/10.);
		AddEntry("Lambda", m1, m2, 0.639/10.);
	}
	
	if (channel == "kk" || channel == "nopid")
	{
		//bottom mesons
		AddEntry("B0_kk", m1, m2, 0.5, 0);
	}
	else
	{
		AddEntry("B0_kk", m1, m2, 0.5/10., 0);
	}
	if (channel == "kp" || channel == "nopid")
	{
		//bottom mesons
		AddEntry("B0_kp", m1, m2, 0.05);
	}
	else
	{
		//bottom mesons
		AddEntry("B0_kp", m1, m2, 0.05/10);
	}
	//-----------------------------------------//

	//pipi channel ----------------------------//
	if (channel == "pipi" || channel == "nopid")
	{
		//light unflavored mesons
		AddEntry("rho770", m1, m2, 1, 0);
		AddEntry("omega782", m1, m2, 0.015, 0);
		AddEntry("f2_1270", m1, m2, 0.84, 0);
		AddEntry("f0_1500_pipi", m1, m2, 0.08, 0);
		AddEntry("f2p_1525_pipi", m1, m2, 0.083, 0);
		AddEntry("f2_2000", m1, m2, 1, 0);
		AddEntry("rho_2000", m1, m2, 1, 0);
		AddEntry("f0_2060", m1, m2, 1, 0);
		AddEntry("f4_2050_pipi", m1, m2, 0.17, 0);
		AddEntry("rho3_1690_pipi", m1, m2, 0.236, 0);
		AddEntry("f2_2240", m1, m2, 1, 0);
		AddEntry("f6_2510", m1, m2, 0.06, 0);
	}
	//-----------------------------------------//

	//kpi channel -----------------------------//
	if (channel == "kpi" || channel == "nopid")
	{
		//strange mesons
		AddEntry("Kstar700", m1, m2, 1);
		AddEntry("Kstar892", m1, m2, 1);
		AddEntry("Kstar1410", m1, m2, 0.066);
		AddEntry("Kstar0_1430", m1, m2, 0.93);
		AddEntry("Kstar2_1430", m1, m2, 0.499);
		AddEntry("Kstar_1680", m1, m2, 0.387);
		AddEntry("Kstar3_1780", m1, m2, 0.31);
		AddEntry("Kstar0_1950", m1, m2, 0.31);
		AddEntry("Kstar4_2045", m1, m2, 0.099);
		AddEntry("Kstar5_2380", m1, m2, 0.061);
	}
	//-----------------------------------------//

	//kk channel ------------------------------//
	if (channel == "kk" || channel == "nopid")
	{
		//light unflavored mesons
		AddEntry("phi1020", m1, m2, 1, 0);
		AddEntry("a2_1320", m1, m2, 0.049, 0);
		AddEntry("a0_1450", m1, m2, 1, 0);
		AddEntry("f0_1500_kk", m1, m2, 0.345, 0);
		AddEntry("f2p_1525_kk", m1, m2, 0.876, 0);
		AddEntry("rho3_1690_kk", m1, m2, 0.0158, 0);
		AddEntry("a2_1700", m1, m2, 0.019, 0);
		AddEntry("f4_2050_kk", m1, m2, 0.068, 0);
	}
	//-----------------------------------------//

	//ppi channel -----------------------------//
	if (channel == "ppi" || channel == "nopid")
	{
		//delta baryons
		AddEntry("Delta1232", m1, m2, 0.5);
		AddEntry("Delta1600", m1, m2, 0.08);
		AddEntry("Delta1620", m1, m2, 0.15);
		AddEntry("Delta1700", m1, m2, 0.0375);
		AddEntry("Delta1900", m1, m2, 0.04);
		AddEntry("Delta1905", m1, m2, 0.07);
		AddEntry("Delta1910", m1, m2, 0.1);
		AddEntry("Delta1920", m1, m2, 0.0625);
		AddEntry("Delta1930", m1, m2, 0.05);
		AddEntry("Delta1940", m1, m2, 0.05);
		AddEntry("Delta1950", m1, m2, 0.1);
		AddEntry("Delta2000", m1, m2, 0.035);
		AddEntry("Delta2150", m1, m2, 0.04);
		AddEntry("Delta2200", m1, m2, 0.025);
		AddEntry("Delta2300", m1, m2, 0.0225);
		AddEntry("Delta2350", m1, m2, 0.085);
		AddEntry("Delta2390", m1, m2, 0.0375);
		AddEntry("Delta2400", m1, m2, 0.04);
		AddEntry("Delta2420", m1, m2, 0.0375);
		AddEntry("Delta2750", m1, m2, 0.02);
		AddEntry("Delta2950", m1, m2, 0.02);
	}
	//-----------------------------------------//
	
	//pk channel ------------------------------//
	if (channel == "pk" || channel == "nopid")
	{
		//N baryons
		AddEntry("N1440", m1, m2, 0.15);
		AddEntry("N1520", m1, m2, 0.15);
		AddEntry("N1535", m1, m2, 0.1);
		AddEntry("N1650", m1, m2, 0.15);
		AddEntry("N1650", m1, m2, 0.1);
		AddEntry("N1680", m1, m2, 0.16);
		AddEntry("N1700", m1, m2, 0.06);
		AddEntry("N1710", m1, m2, 0.063);
		AddEntry("N1720", m1, m2, 0.06);
		AddEntry("N1860", m1, m2, 0.06);
		AddEntry("N1880", m1, m2, 0.07);
		AddEntry("N1895", m1, m2, 0.05);
		AddEntry("N1900", m1, m2, 0.05);
		AddEntry("N2000", m1, m2, 0.025);
		AddEntry("N1990", m1, m2, 0.015);
		AddEntry("N2060", m1, m2, 0.05);
		AddEntry("N2100", m1, m2, 0.1);
		AddEntry("N2120", m1, m2, 0.05);
		AddEntry("N2190", m1, m2, 0.075);
		AddEntry("N2200", m1, m2, 0.0113);
		AddEntry("N2250", m1, m2, 0.05);
		AddEntry("N2600", m1, m2, 0.02);
		AddEntry("N2700", m1, m2, 0.03);
		
		//lambda baryons
		AddEntry("Lambda1520", m1, m2, 0.225);
		AddEntry("Lambda1600", m1, m2, 0.1125);
		AddEntry("Lambda1670", m1, m2, 0.125);
		AddEntry("Lambda1690", m1, m2, 0.125);
		AddEntry("Lambda1710", m1, m2, 0.115);
		AddEntry("Lambda1800", m1, m2, 0.1875);
		AddEntry("Lambda1810", m1, m2, 0.1);
		AddEntry("Lambda1820", m1, m2, 0.15);
		AddEntry("Lambda1890", m1, m2, 0.15);
		AddEntry("Lambda2000", m1, m2, 0.0675);
		AddEntry("Lambda2050", m1, m2, 0.0475);
		AddEntry("Lambda2070", m1, m2, 0.03);
		AddEntry("Lambda2080", m1, m2, 0.02);
		AddEntry("Lambda2100", m1, m2, 0.075);
		AddEntry("Lambda2110", m1, m2, 0.075);
		AddEntry("Lambda2350", m1, m2, 0.03);
		
		//sigma baryons
		AddEntry("Sigma1620", m1, m2, 0.175);
		AddEntry("Sigma1660", m1, m2, 0.025);
		AddEntry("Sigma1670", m1, m2, 0.02);
		AddEntry("Sigma1750", m1, m2, 0.045);
		AddEntry("Sigma1775", m1, m2, 0.1);
		AddEntry("Sigma1780", m1, m2, 0.01);
		AddEntry("Sigma1880", m1, m2, 0.1);
		AddEntry("Sigma1900", m1, m2, 0.225);
		AddEntry("Sigma1910", m1, m2, 0.0125);
		AddEntry("Sigma1915", m1, m2, 0.0125);
		AddEntry("Sigma1940", m1, m2, 0.065);
		AddEntry("Sigma2010", m1, m2, 0.035);
		AddEntry("Sigma2030", m1, m2, 0.1);
		AddEntry("Sigma2100", m1, m2, 0.04);
		AddEntry("Sigma2110", m1, m2, 0.065);
		AddEntry("Sigma2230", m1, m2, 0.03);
		AddEntry("Sigma2250", m1, m2, 0.03);
	}
	//-----------------------------------------//

	//pp channel ------------------------------//
	if (channel == "pp" || channel == "nopid")
	{
		//c bar mesons
		AddEntry("etac1s", m1, m2, 0.0144E-3, 0);
	}
	//-----------------------------------------//

	//ee channel ------------------------------//
	if (channel == "ee" || channel == "nopid")
	{
		//c bar mesons
		AddEntry("jpsi1s", m1, m2, 0.0597, 0);
		
		//b bar mesons
		AddEntry("upsilon1s", m1, m2, 0.0238E-3, 0);
		AddEntry("upsilon2s", m1, m2, 0.0191E-3, 0);
		AddEntry("upsilon3s", m1, m2, 0.0191E-3, 0);
	}
	//-----------------------------------------//

	TFile *output_file = new TFile(output_file_name.c_str(), "RECREATE");

	Init(mass_distr, output_file);

	mass_distr->Draw();
	mass_distr->Write();
	
	return 0;
}

void AddEntry(std::string part_name, const float m1, const float m2, const float channel_fract, bool do_antipart = true)
{
	std::string input_file_name = "../data/" + part_name + ".root";
	CheckInputFile(input_file_name);
	
	Par.part_name.push_back(part_name);
	Par.m1.push_back(m1);
	Par.m2.push_back(m2);
	

	//adding antiparticles
	if (do_antipart == true)
	{
		Par.weight.push_back(channel_fract);
		std::string antipart_name = "anti" + part_name;
		AddEntry(antipart_name, m2, m1, channel_fract, false);
	}
	else
	{
		Par.weight.push_back(channel_fract*2.);
	}
}

void Init(TH2F *mass_distr, TFile *output_file)
{
	for (int count = 0; count < Par.m1.size(); count++)
	{
		cout << OutputColor.bold_green << "[" << count+1 << " out of " << Par.m1.size() << "] " << OutputColor.reset << "Restoring ";
		RestoreMass(Par.part_name[count], Par.m1[count], Par.m2[count], mass_distr, output_file, Par.weight[count]);
	}
}

void RestoreMass(std::string part_name, const float m1, const float m2, TH2F *mass_distr, TFile *output_file, const float weight = 1)
{
	std::string input_file_name = "../data/" + part_name + ".root";
	TFile *input_file = new TFile(input_file_name.c_str(), "READ");

	TTree *D1 = (TTree*) input_file->Get("D1");
	TTree *D2 = (TTree*) input_file->Get("D2");

	unsigned const int res_num = D1->GetEntries();

	std::cout << res_num << " particles with the name: " << part_name << std::endl;

	float p1[3], p2[3];
	float mom1, mom2;
	float momentum, mass, pT;

	float progress = 0;

	TH2F part_distr = TH2F(part_name.c_str(), part_name.c_str(), 100, 0, 10, 6000, 0, 12);
	
	for (float counter = 0; counter < res_num; counter++)
	{
		ProgressBar.Block((float) (counter + 1.)/res_num);

		D1->GetEntry(static_cast<unsigned long>(counter));
		D2->GetEntry(static_cast<unsigned long>(counter));

		p1[0] = D1->GetLeaf("px")->GetValue();	
		p1[1] = D1->GetLeaf("py")->GetValue();	
		p1[2] = D1->GetLeaf("pz")->GetValue();	

		p2[0] = D2->GetLeaf("px")->GetValue();	
		p2[1] = D2->GetLeaf("py")->GetValue();	
		p2[2] = D2->GetLeaf("pz")->GetValue();	

		//momentum for the next 3 lines are squared

		momentum = pow(p1[0]+p2[0], 2) + pow(p1[1]+p2[1], 2) + pow(p1[2]+p2[2], 2);

		mom1 = pow(p1[0], 2) + pow(p1[1], 2) + pow(p1[2], 2);
		mom2 = pow(p2[0], 2) + pow(p2[1], 2) + pow(p2[2], 2);

		mass = GetMass(mom1, mom2, momentum, m1, m2);

		float pT = sqrt(pow(p1[0]+p2[0], 2) + pow(p1[1]+p2[1], 2));
		if (pT < 0.6) continue;

		//if (checkEnergy(p1, p2, mass, m1, m2)) continue;

		mass_distr->Fill(pT, mass, weight);
		part_distr.Fill(pT, mass, weight);
	}
	
	input_file->Close();

	output_file->cd();
	part_distr.Write();

	delete input_file, D1, D2;	
}

float GetMass(const float mom1, const float mom2, const float momentum, const float m1, const float m2)
{
	float e1 = sqrt(mom1 + m1*m1);
	float e2 = sqrt(mom2 + m2*m2);

	float mass = sqrt(pow(e1+e2, 2) - momentum);

	return mass;
}

bool checkEnergy(float *p1, float *p2, const float mass, const float m1, const float m2)
{
	float energy, e1, e2, vel, gamma, phi;
	float mom = 0, mom1 = 0, mom2 = 0;
	const float pi = 3.14159265359;
	float p1_tmp[3], p2_tmp[3];

	for (int count = 0; count < 3; count++)
	{
		float p;

		p = p1[count]+p2[count];

		p1_tmp[count] = p1[count];
		p2_tmp[count] = p2[count];

		mom1 += p1[count]*p1[count];
		mom2 += p2[count]*p2[count];

		mom += p*p;
	}
	
	e1 = sqrt(mom1 + m1*m1);
	e2 = sqrt(mom2 + m2*m2);
	energy = e1 + e2;

	vel = sqrt(mom)/energy;
	gamma = energy/mass;

	//transforming the cortesian basis for momentum to be p=px
	phi = -atan((p1[1]+p2[1])/(p1[0]+p2[0]));

	p1[0] = p1_tmp[0]*cos(phi) - p1_tmp[1]*sin(phi);
	p2[0] = p2_tmp[0]*cos(phi) - p2_tmp[1]*sin(phi);

	p1[1] = p1_tmp[0]*sin(phi) + p1_tmp[1]*cos(phi);
	p2[1] = p2_tmp[0]*sin(phi) + p2_tmp[1]*cos(phi);

	p1_tmp[0] = p1[0];
	p2_tmp[0] = p2[0];

	phi = -atan((p1[2]+p2[2])/(p1[0]+p2[0]));

	p1[0] = p1_tmp[0]*cos(phi) - p1_tmp[2]*sin(phi);
	p2[0] = p2_tmp[0]*cos(phi) - p2_tmp[2]*sin(phi);

	p1[2] = p1_tmp[0]*sin(phi) + p1_tmp[2]*cos(phi);
	p2[2] = p2_tmp[0]*sin(phi) + p2_tmp[2]*cos(phi);

	e1 = gamma*(e1 - vel*abs(p1[0]));
	e2 = gamma*(e2 - vel*abs(p2[0]));

	energy = e1 + e2;

	float e1_true = (mass*mass + m1*m1 - m2*m2)/(2*mass);
	float e2_true = (mass*mass + m2*m2 - m1*m1)/(2*mass);

	if (abs(e1 - e1_true) < 0.001 && abs (e2 - e2_true) < 0.001) {
		//cout << mass << " " << energy - mass << " " << e1 - e1_true << " " << e2 - e2_true << endl;
		return true;
	}

	return false;
}
